

<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>fetch.js - Alpinejs-app Documentation</title>
    
    <meta name="description" content="A Simplest Single Page Application (SPA) library for Alpine.js." />
    
    
    

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>

    
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <input type="text" id="nav-search" placeholder="Search" />
    
    
    <h2><a href="index.html">Home</a></h2><h3>Tutorials</h3><ul><li><a href="tutorial-start.html">Getting Started</a><ul class='members'><li data-type='method' style='display: none;'><a href="tutorial-start.html#installation">Installation</a></li><li data-type='method' style='display: none;'><a href="tutorial-start.html#first-app">First app</a></li></ul></li><li><a href="tutorial-components.html">Components</a><ul class='members'><li data-type='method' style='display: none;'><a href="tutorial-components.html#component-lifecycle-and-event-handling">Component Lifecycle and Event Handling</a></li><li data-type='method' style='display: none;'><a href="tutorial-components.html#event-emitter">Event emitter</a></li><li data-type='method' style='display: none;'><a href="tutorial-components.html#custom-elements">Custom Elements</a></li><li data-type='method' style='display: none;'><a href="tutorial-components.html#examples">Examples</a></li></ul></li><li><a href="tutorial-directives.html">Directives</a><ul class='members'><li data-type='method' style='display: none;'><a href="tutorial-directives.html#directive-x-template">Directive: **x-template**</a></li><li data-type='method' style='display: none;'><a href="tutorial-directives.html#directive-x-render">Directive: **x-render**</a></li><li data-type='method' style='display: none;'><a href="tutorial-directives.html#directive-x-scope-level">Directive: **x-scope-level**</a></li><li data-type='method' style='display: none;'><a href="tutorial-directives.html#directive-x-droppable">Directive: **x-droppable**</a></li></ul></li><li><a href="tutorial-magics.html">Magics</a><ul class='members'><li data-type='method' style='display: none;'><a href="tutorial-magics.html#magic-app">Magic: **$app**</a></li><li data-type='method' style='display: none;'><a href="tutorial-magics.html#magic-component">Magic: **$component**</a></li><li data-type='method' style='display: none;'><a href="tutorial-magics.html#magic-parent">Magic: **$parent**</a></li><li data-type='method' style='display: none;'><a href="tutorial-magics.html#magic-params">Magic: **$params**</a></li></ul></li></ul><h3>Classes</h3><ul><li><a href="AlpineComponent.html">AlpineComponent</a><ul class='methods'><li data-type='method' style='display: none;'><a href="AlpineComponent.html#destroy">destroy</a></li><li data-type='method' style='display: none;'><a href="AlpineComponent.html#init">init</a></li></ul></li><li><a href="Component.html">Component</a><ul class='methods'><li data-type='method' style='display: none;'><a href="Component.html#destroy">destroy</a></li><li data-type='method' style='display: none;'><a href="Component.html#init">init</a></li></ul></li></ul><h3>Namespaces</h3><ul><li><a href="app.html">app</a></li></ul><h3>Global</h3><ul><li><a href="global.html#$">$</a></li><li><a href="global.html#$all">$all</a></li><li><a href="global.html#$append">$append</a></li><li><a href="global.html#$attr">$attr</a></li><li><a href="global.html#$data">$data</a></li><li><a href="global.html#$elem">$elem</a></li><li><a href="global.html#$empty">$empty</a></li><li><a href="global.html#$event">$event</a></li><li><a href="global.html#$off">$off</a></li><li><a href="global.html#$on">$on</a></li><li><a href="global.html#$param">$param</a></li><li><a href="global.html#$parse">$parse</a></li><li><a href="global.html#$ready">$ready</a></li><li><a href="global.html#__">__</a></li><li><a href="global.html#afetch">afetch</a></li><li><a href="global.html#call">call</a></li><li><a href="global.html#emit">emit</a></li><li><a href="global.html#escape">escape</a></li><li><a href="global.html#fetch">fetch</a></li><li><a href="global.html#fetchOptions">fetchOptions</a></li><li><a href="global.html#forEach">forEach</a></li><li><a href="global.html#forEachSeries">forEachSeries</a></li><li><a href="global.html#hideAlert">hideAlert</a></li><li><a href="global.html#hideToast">hideToast</a></li><li><a href="global.html#isArray">isArray</a></li><li><a href="global.html#isElement">isElement</a></li><li><a href="global.html#isFlag">isFlag</a></li><li><a href="global.html#isFunction">isFunction</a></li><li><a href="global.html#isNumber">isNumber</a></li><li><a href="global.html#isObject">isObject</a></li><li><a href="global.html#isString">isString</a></li><li><a href="global.html#loadResources">loadResources</a></li><li><a href="global.html#log">log</a></li><li><a href="global.html#noop">noop</a></li><li><a href="global.html#off">off</a></li><li><a href="global.html#on">on</a></li><li><a href="global.html#once">once</a></li><li><a href="global.html#only">only</a></li><li><a href="global.html#parallel">parallel</a></li><li><a href="global.html#parsePath">parsePath</a></li><li><a href="global.html#register">register</a></li><li><a href="global.html#render">render</a></li><li><a href="global.html#resolve">resolve</a></li><li><a href="global.html#restorePath">restorePath</a></li><li><a href="global.html#sanitizer">sanitizer</a></li><li><a href="global.html#savePath">savePath</a></li><li><a href="global.html#sendFile">sendFile</a></li><li><a href="global.html#series">series</a></li><li><a href="global.html#showAlert">showAlert</a></li><li><a href="global.html#showToast">showToast</a></li><li><a href="global.html#split">split</a></li><li><a href="global.html#start">start</a></li><li><a href="global.html#stylePlugin">stylePlugin</a></li><li><a href="global.html#toCamel">toCamel</a></li><li><a href="global.html#toDate">toDate</a></li><li><a href="global.html#toDuration">toDuration</a></li><li><a href="global.html#toNumber">toNumber</a></li><li><a href="global.html#toPrice">toPrice</a></li><li><a href="global.html#toSize">toSize</a></li><li><a href="global.html#toTitle">toTitle</a></li><li><a href="global.html#trace">trace</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">fetch.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>
import { call, isFunction, isObject, isString, trace } from "./app"

/**
 * Global object to customize {@link fetch} and {@link afetch}
 * @example &lt;caption>make POST default method&lt;/caption>
 * fetchOptions.method = "POST"
 * await afetch("url.com")
 */
export var fetchOptions = {
    method: "GET",
    cache: "default",
    headers: {},
};

function parseOptions(url, options)
{
    const headers = options?.headers || {};
    const opts = Object.assign({
        headers,
        method: options?.method || options?.post &amp;&amp; "POST" || undefined,
    }, options?.request);

    for (const p in fetchOptions.headers) {
        headers[p] ??= fetchOptions.headers[p];
    }
    for (const p of ["method","cache","credentials","duplex","integrity","keepalive","mode","priority","redirect","referrer","referrerPolicy","signal"]) {
        if (fetchOptions[p] !== undefined) {
            opts[p] ??= fetchOptions[p];
        }
    }
    var body = options?.body;
    if (opts.method == "GET" || opts.method == "HEAD") {
        if (isObject(body)) {
            url += "?" + new URLSearchParams(body).toString();
        }
    } else
    if (isString(body)) {
        opts.body = body;
        headers["content-type"] ??= 'application/x-www-form-urlencoded; charset=UTF-8';
    } else
    if (body instanceof FormData) {
        opts.body = body;
        delete headers["content-type"];
    } else
    if (isObject(body)) {
        opts.body = JSON.stringify(body);
        headers["content-type"] = "application/json; charset=UTF-8";
    } else
    if (body) {
        opts.body = body;
        headers["content-type"] ??= "application/octet-stream";
    }
    return [url, opts];
}


function parseResponse(res)
{
    const info = { status: res.status, headers: {}, type: res.type, url: res.url, redirected: res.redirected };
    for (const h of res.headers) {
        info.headers[h[0].toLowerCase()] = h[1];
    }
    const h_csrf = fetchOptions.csrfHeader || "x-csrf-token";
    const v_csrf = info?.headers[h_csrf];
    if (v_csrf) {
        if (v_csrf &lt;= 0) {
            delete fetchOptions.headers[h_csrf];
        } else {
            fetchOptions.headers[h_csrf] = v_csrf;
        }
    }
    return info;
}

/**
 * Fetch remote content, wrapper around Fetch API
 *
 * __NOTE: Saves X-CSRF-Token header and sends it back with subsequent requests__
 * @param {string} url - URL to fetch
 * @param {object} [options]
 * @param {string} [options.method] - GET, POST,...GET is default or from app.fetchOptions.method
 * @param {boolean} [options.post] - set method to POST
 * @param {string|object|FormData} [options.body] - a body accepted by window.fetch
 * @param {string} [options.dataType] - explicit return type: text, blob, default is auto detected between text or json
 * @param {object} [options.headers] - an object with additional headers to send, all global headers from app.fetchOptions.headers also are merged
 * @param {object} [options.request] - properties to pass to fetch options according to Web API `RequestInit`
 * @param {function} [callback] - callback as (err, data, info) where info is an object { status, headers, type }
 *
 * @example
 * fetch("http://api.host.com/user/123", (err, data, info) => {
 *    if (info.status == 200) console.log(data, info);
 * });
 */

export function fetch(url, options, callback)
{
    if (isFunction(options)) callback = options, options = null;

    try {
        const [uri, opts] = parseOptions(url, options);
        trace("fetch:", uri, opts, options);

        window.fetch(uri, opts).
        then(async (res) => {
            var err, data, info = parseResponse(res);
            if (!res.ok) {
                if (/\/json/.test(info.headers["content-type"])) {
                    const d = await res.json();
                    err = { status: res.status };
                    for (const p in d) err[p] = d[p];
                } else {
                    err = { message: await res.text(), status: res.status };
                }
                return call(callback, err, data, info);
            }
            switch (options?.dataType) {
            case "text":
                data = await res.text();
                break;
            case "blob":
                data = await res.blob();
                break;
            default:
                data = /\/json/.test(info.headers["content-type"]) ? await res.json() : await res.text();
            }
            call(callback, null, data, info);
        }).catch (err => {
            call(callback, err);
        });
    } catch (err) {
        call(callback, err);
    }
}

/**
 * Promisified {@link fetch} which returns a Promise, all exceptions are passed to the reject handler, no need to use try..catch
 * Return everything in an object `{ ok, status, err, data, info }`.
 * @example
 * const { err, data } = await afetch("https://localhost:8000")
 *
 * const { ok, err, status, data } = await afetch("https://localhost:8000")
 * if (!ok) console.log(status, err);
 * @param {string} url
 * @param {object} [options]
 * @async
 */

export function afetch(url, options)
{
    return new Promise((resolve, reject) => {
        fetch(url, options, (err, data, info) => {
            resolve({ ok: !err, status: info.status, err, data, info });
        });
    });
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.5</a> using the <a href="https://github.com/vseryakov/docdash">docdash</a> theme.
</footer>


<script src="scripts/search.js" defer></script>



<script src="scripts/collapse.js" defer></script>



</body>
</html>
